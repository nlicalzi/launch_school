## JS230 Lesson 3: Making HTTP Requests from JavaScript

### Summary

### Notes

* **What to Focus On**
  * **Think HTTP**
    * HTTP is the protocol used by the network operations we cover in this lesson. You must be familiar with the request-response cycle, the components of each part, and how you can access these values from JS.
  * **Be Familiar with `XMLHttpRequest`**
    * Know how to use `XMLHttpRequest` to send requests and how to execute code at specific points as the request moves through its lifecycle.
    * Know how to handle successful and unsuccessful requests.
  * **Understand how to Serialize Data**
    * Know how to use `XMLHttpRequest` to submit a form from a webpage and send requests using JSON-formatted data.
  * **Decompose Functionality into API Requests**
    * While each API is different, you should be able to translate a requirement that says "create a post on the server" into "make a POST request to `/posts` with the required JSON data" and be able to write the code that does it.
  * **Read API Documentation**
    * Don't try to memorize the details of the web APIs that we discuss. Try instead to internalize the conventions you see and learn to find the specifics in the documentation.

________

* **Book: Working with Web APIs**
  * See notes in `launch_school/open_book_shelf`

________

* **Network Programming in JavaScript**
  * **AJAX** / **A**synchronoux **J**avaScript **A**nd **X**ML enables developers to fetch data (typically HTML or XML) and update specific parts of a page. 
    * "An AJAX request" or "via AJAX" refers to an HTTP request from a browser that *does not perform a full page load*.
  * Single Page Applications
    * A **single page application** runs entirely within a single HTML page: instead of fetching bits of HTML generated by a server, this model does all interactions by passing data to and from the server, often encoded as JSON.

________

* **Making a Request with `XMLHttpRequest` (XHR)**

  * We use the `XMLHttpRequest` object to send an HTTP request with JavaScript.

    * This is provided as part of the browser API, not the JS language.

    * ```javascript
      let request = new XMLHttpRequest(); // Instantiate new XHR object
      request.open('GET', '/path');				// Set HTTP method and URL on request
      request.send();											// Send request
      
      // Before the request completes:
      request.responseText; // => ""
      request.status; 			// => 0
      request.statusText; 	// => ""
      
      // After the request completes:
      request.responseText; // body of response
      request.status; 			// status code of response
      request.statusText;		// status text of response
      request.getResponseHeader('Content-Type'); // response header
      ```

    * `request.send` is asynchronous, so code execution continues while it executes in background.

      * ```javascript
        // wait for response by listening for the `load` event
        request.addEventListener('load', event => {
          var request = event.target; 	// the XMLHttpRequest object
          
          request.responseText;
          request.status;
          request.statusText;
          
          request.getResponseHeader('Content-Type');
          request.readyState;
        });
        ```

  * An Overview of `XMLHttpRequest` Methods

    * `open(method, url)`: open a connection to `url` using `method`
    * `send(data)`: send the request, optionally sending along `data`
    * `setRequestHeader(header, value)`: set HTTP `header` to `value`
    * `abort()`: cancel an active request
    * `getResponseHeader(header)`: return the response's value for `header`

  * Particularly Useful `XMLHttpRequest` Properties

    | Property       | Writable | Default Value | Description                                                  |
    | :------------- | :------- | :------------ | :----------------------------------------------------------- |
    | `timeout`      | Yes      | `0`           | Maximum time a request can take to complete (in milliseconds) |
    | `readyState`   | No       |               | What state the request is in (see below)                     |
    | `responseText` | No       | `null`        | Raw text of the response's body.                             |
    | `response`     | No       | `null`        | Parsed content of response, *not meaningful in all situations* |

  * Problems

    * ```javascript
      var request = new XMLHttpRequest();
      request.open('GET', 'https://api.github.com/repos/rails/rails');
      request.send();
      
      request.responseText; // response body
      ```

_________

* **`XMLHttpRequest` Events**
  * Two main events fire during an `XMLHttpRequest` cycle: 
    * `loadstart`: request sent to server
    * `loadend`: response done loading and all other events have fired (last event to fire)
  * Before `loadend` fires, an event will fire based on whether the request was successful:
    * `load`: a complete response loaded
    * `abort`: the request was interrupted before it could complete
    * `error`: an error occured
    * `timeout`: a response wasn't received before the timeout period ended
    * <img src="https://d3905n0khyu9wc.cloudfront.net/images/220_xhr_main_events.png" alt="XMLHttpRequest lifecycle events" style="zoom:40%;float: left;" />
  * The application code itself is responsible for determining whether a `request` was successful by inspecting the response within a `load` event handler.

_________

* **Data Serialization**

  * Request Serialization Formats

    * JS applications that run in a web browser must **serialize** data when sending/receiving data.
    * Applications can use any **data serialization format** that both client/server can read/write in.

  * Query String / URL Encoding

    * A query string consists of one or more `name=value` pairs separated by the `&` character (spaces can be represented either by `%20` or `+`)

      * JS provides a built-in function `encodeURIComponent` that lets you encode a string:

        * ```javascript
          let uri = "title=Do Androids Dream of Electric Sheep?&year=1968";
          console.log(encodeURIComponent(uri));
          // => title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968
          ```

    * ```http
      GET /path?title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968 HTTP/1.1
      Host: example.test
      Accept: */*
      ```

    * ```http
      //POST requests need a Content-Type header of application/x-www-form-urlencoded
      POST /path HTTP/1.1
      Host: example.test
      Content-Length: 54
      Content-Type: application/x-www-form-urlencoded; charset=utf-8
      Accept: */*
      
      title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968
      ```

  * Multipart Forms

    * POST requests use multipart form formats for forms that include file uploads or that use `FormData` objects to collect data.

    * This format isn't strictly an encoding format since we don't encode anything, instead placing each name-value pair in a separate section of the request body, separated by a **boundary delimiter** that's defined in the `Content-Type` request header:

      * ```http
        POST /path HTTP/1.1
        Host: example.test
        Content-Length: 267
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundarywDbHM6i57QWyAWro
        Accept: */*
        
        ------WebKitFormBoundarywDbHM6i57QWyAWro
        Content-Disposition: form-data; name="title"
        
        Do Androids Dream of Electric Sheep?
        ------WebKitFormBoundarywDbHM6i57QWyAWro
        Content-Disposition: form-data; name="year"
        
        1968
        ------WebKitFormBoundarywDbHM6i57QWyAWro--
        ```

      * The final delimiter has `--` appended, signaling the end of the multipart content.

  * JSON Serialization

    * **JSON** (**JavaScript Object Notation**) is a popular data serialization format used by APIs.

    * A `GET` request can return JSON, but we must use `POST` to send JSON data to the server.

    * ```http
      POST /path HTTP/1.1
      Host: example.test
      Content-Length: 62
      Content-Type: application/json; charset=utf-8
      Accept: */*
      
      {"title":"Do Androids Dream of Electric Sheep?","year":"1968"}
      ```

      * Note that `Content-Type` has a value of `application/json; charset=utf-8`

  * `Content-Type` and `charset`

    * Note: `charset` is optional, but it's best practice to include it except when using multipart form format. Providing the `charset` ensures that the server interprets the data with the correct incoding, and we can use `charset=utf-8` in most cases.

________

* **Example: Loading HTML via XHR**

  * We can use an `XMLHttpRequest` object to fetch content in an existing web page without a full page reload.

  * We can attach event listeners to content embedded in the page to circumvent the browser's default behavior and create custom interactions.

  * ```javascript
    document.addEventListener('DOMContentLoaded', () => {
      let store = document.getElementById('store');
      
      let request = new XMLHttpRequest();
      request.open('GET', 'https://ls-230-web-store-demo.herokuapp.com/products');
      
      request.addEventListener('load', event => store.innerHTML = request.response);
      request.send();
      
      store.addEventListener('click', event => {
        let target = event.target;
        if (target.tagName !== 'A') { return; }
        
        event.preventDefault();
        
        let request = new XMLHttpRequest();
        request.open('GET', 'https://ls-230-web-store-demo.herokuapp.com' +
                    				target.getAttrubute('href'));
        
        request.addEventListener('load', event => store.innerHTML = request.response);
        request.send();
      });
    });
    ```

________

* **Example: Submitting a Form via XHR**

________

* **Example: Loading JSON via XHR**

________

* **Example: Sending JSON via XHR**

________

* **Cross-Domain `XMLHttpRequests` with CORS**

### Concepts/Vocab



















