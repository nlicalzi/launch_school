## JS230 Lesson 3: Making HTTP Requests from JavaScript

### Summary

### Notes

* **What to Focus On**
  * **Think HTTP**
    * HTTP is the protocol used by the network operations we cover in this lesson. You must be familiar with the request-response cycle, the components of each part, and how you can access these values from JS.
  * **Be Familiar with `XMLHttpRequest`**
    * Know how to use `XMLHttpRequest` to send requests and how to execute code at specific points as the request moves through its lifecycle.
    * Know how to handle successful and unsuccessful requests.
  * **Understand how to Serialize Data**
    * Know how to use `XMLHttpRequest` to submit a form from a webpage and send requests using JSON-formatted data.
  * **Decompose Functionality into API Requests**
    * While each API is different, you should be able to translate a requirement that says "create a post on the server" into "make a POST request to `/posts` with the required JSON data" and be able to write the code that does it.
  * **Read API Documentation**
    * Don't try to memorize the details of the web APIs that we discuss. Try instead to internalize the conventions you see and learn to find the specifics in the documentation.

________

* **Book: Working with Web APIs**
  * See notes in `launch_school/open_book_shelf`

________

* **Network Programming in JavaScript**
  * **AJAX** / **A**synchronoux **J**avaScript **A**nd **X**ML enables developers to fetch data (typically HTML or XML) and update specific parts of a page. 
    * "An AJAX request" or "via AJAX" refers to an HTTP request from a browser that *does not perform a full page load*.
  * Single Page Applications
    * A **single page application** runs entirely within a single HTML page: instead of fetching bits of HTML generated by a server, this model does all interactions by passing data to and from the server, often encoded as JSON.

________

* **Making a Request with `XMLHttpRequest` (XHR)**

  * We use the `XMLHttpRequest` object to send an HTTP request with JavaScript.

    * This is provided as part of the browser API, not the JS language.

    * ```javascript
      let request = new XMLHttpRequest(); // Instantiate new XHR object
      request.open('GET', '/path');				// Set HTTP method and URL on request
      request.send();											// Send request
      
      // Before the request completes:
      request.responseText; // => ""
      request.status; 			// => 0
      request.statusText; 	// => ""
      
      // After the request completes:
      request.responseText; // body of response
      request.status; 			// status code of response
      request.statusText;		// status text of response
      request.getResponseHeader('Content-Type'); // response header
      ```

    * `request.send` is asynchronous, so code execution continues while it executes in background.

      * ```javascript
        // wait for response by listening for the `load` event
        request.addEventListener('load', event => {
          var request = event.target; 	// the XMLHttpRequest object
          
          request.responseText;
          request.status;
          request.statusText;
          
          request.getResponseHeader('Content-Type');
          request.readyState;
        });
        ```

  * An Overview of `XMLHttpRequest` Methods

    * `open(method, url)`: open a connection to `url` using `method`
    * `send(data)`: send the request, optionally sending along `data`
    * `setRequestHeader(header, value)`: set HTTP `header` to `value`
    * `abort()`: cancel an active request
    * `getResponseHeader(header)`: return the response's value for `header`

  * Particularly Useful `XMLHttpRequest` Properties

    | Property       | Writable | Default Value | Description                                                  |
    | :------------- | :------- | :------------ | :----------------------------------------------------------- |
    | `timeout`      | Yes      | `0`           | Maximum time a request can take to complete (in milliseconds) |
    | `readyState`   | No       |               | What state the request is in (see below)                     |
    | `responseText` | No       | `null`        | Raw text of the response's body.                             |
    | `response`     | No       | `null`        | Parsed content of response, *not meaningful in all situations* |

  * Problems

    * ```javascript
      var request = new XMLHttpRequest();
      request.open('GET', 'https://api.github.com/repos/rails/rails');
      request.send();
      
      request.responseText; // response body
      ```

_________

* **`XMLHttpRequest` Events**
  * Two main events fire during an `XMLHttpRequest` cycle: 
    * `loadstart`: request sent to server
    * `loadend`: response done loading and all other events have fired (last event to fire)
  * Before `loadend` fires, an event will fire based on whether the request was successful:
    * `load`: a complete response loaded
    * `abort`: the request was interrupted before it could complete
    * `error`: an error occured
    * `timeout`: a response wasn't received before the timeout period ended
    * <img src="https://d3905n0khyu9wc.cloudfront.net/images/220_xhr_main_events.png" alt="XMLHttpRequest lifecycle events" style="zoom:40%;float: left;" />
  * The application code itself is responsible for determining whether a `request` was successful by inspecting the response within a `load` event handler.

_________

* **Data Serialization**

  * Request Serialization Formats

    * JS applications that run in a web browser must **serialize** data when sending/receiving data.
    * Applications can use any **data serialization format** that both client/server can read/write in.

  * Query String / URL Encoding

    * A query string consists of one or more `name=value` pairs separated by the `&` character (spaces can be represented either by `%20` or `+`)

      * JS provides a built-in function `encodeURIComponent` that lets you encode a string:

        * ```javascript
          let uri = "title=Do Androids Dream of Electric Sheep?&year=1968";
          console.log(encodeURIComponent(uri));
          // => title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968
          ```

    * ```http
      GET /path?title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968 HTTP/1.1
      Host: example.test
      Accept: */*
      ```

    * ```http
      //POST requests need a Content-Type header of application/x-www-form-urlencoded
      POST /path HTTP/1.1
      Host: example.test
      Content-Length: 54
      Content-Type: application/x-www-form-urlencoded; charset=utf-8
      Accept: */*
      
      title=Do%20Androids%20Dream%20of%20Electric%20Sheep%3F&year=1968
      ```

  * Multipart Forms

    * POST requests use multipart form formats for forms that include file uploads or that use `FormData` objects to collect data.

    * This format isn't strictly an encoding format since we don't encode anything, instead placing each name-value pair in a separate section of the request body, separated by a **boundary delimiter** that's defined in the `Content-Type` request header:

      * ```http
        POST /path HTTP/1.1
        Host: example.test
        Content-Length: 267
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundarywDbHM6i57QWyAWro
        Accept: */*
        
        ------WebKitFormBoundarywDbHM6i57QWyAWro
        Content-Disposition: form-data; name="title"
        
        Do Androids Dream of Electric Sheep?
        ------WebKitFormBoundarywDbHM6i57QWyAWro
        Content-Disposition: form-data; name="year"
        
        1968
        ------WebKitFormBoundarywDbHM6i57QWyAWro--
        ```

      * The final delimiter has `--` appended, signaling the end of the multipart content.

  * JSON Serialization

    * **JSON** (**JavaScript Object Notation**) is a popular data serialization format used by APIs.

    * A `GET` request can return JSON, but we must use `POST` to send JSON data to the server.

    * ```http
      POST /path HTTP/1.1
      Host: example.test
      Content-Length: 62
      Content-Type: application/json; charset=utf-8
      Accept: */*
      
      {"title":"Do Androids Dream of Electric Sheep?","year":"1968"}
      ```

      * Note that `Content-Type` has a value of `application/json; charset=utf-8`

  * `Content-Type` and `charset`

    * Note: `charset` is optional, but it's best practice to include it except when using multipart form format. Providing the `charset` ensures that the server interprets the data with the correct incoding, and we can use `charset=utf-8` in most cases.

________

* **Example: Loading HTML via XHR**

  * We can use an `XMLHttpRequest` object to fetch content in an existing web page without a full page reload.

  * We can attach event listeners to content embedded in the page to circumvent the browser's default behavior and create custom interactions.

  * ```javascript
    document.addEventListener('DOMContentLoaded', () => {
      let store = document.getElementById('store');
      
      let request = new XMLHttpRequest();
      request.open('GET', 'https://ls-230-web-store-demo.herokuapp.com/products');
      
      request.addEventListener('load', event => store.innerHTML = request.response);
      request.send();
      
      store.addEventListener('click', event => {
        let target = event.target;
        if (target.tagName !== 'A') { return; }
        
        event.preventDefault();
        
        let request = new XMLHttpRequest();
        request.open('GET', 'https://ls-230-web-store-demo.herokuapp.com' +
                    				target.getAttrubute('href'));
        
        request.addEventListener('load', event => store.innerHTML = request.response);
        request.send();
      });
    });
    ```

________

* **Example: Submitting a Form via XHR**

  * URL-encoding POST Parameters

    * ```javascript
      let request = new XMLHttpRequest();
      request.open('POST', 'https://ls-230-book-catalog.herokuapp.com/books');
      
      request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      
      let data = 'title=Effective%20JavaScript&author=David%20Herman';
      
      request.addEventListener('load', () => {
        if (request.status === 201) {
          console.log(`This book was added to the catalog: ${request.responseText}`);
        }
      });
      
      request.send(data);
      ```

    * ```http
      POST /books HTTP/1.1
      Host: ls-230-book-catalog.herokuapp.com
      Content-Length: 50
      Content-type: application/x-www-form-urlencoded
      Accept: */*
      
      title=Effective%20JavaScript&author=David%20Herman
      ```

  * Submitting a Form (use `HTMLFormElement.elements`)

    * ```html
      <form id="form">
        <p><label>Title: <input type="text" name="title"></label></p>
        <p><label>Author: <input type="text" name="author"></label></p>
        <p><button type="submit">Submit</button></p>
      </form>
      ```

    * ```javascript
      let form = document.getElementById('form');
      
      // Bind to the form's submit event to handle the submit button
      // being clicked, enter being pressed within an input, etc.
      form.addEventListener('submit', event => {
        // prevent the browser from submitting the form
        event.preventDefault();
        
        // access the inputs using form.elements and serialize into a string
        let keysAndValues = [];
        
        for (let idx = 0; idx < form.elements.length; idx += 1) {
          let element = form.elements[idx];
          let key;
          let value;
          
          if (element.type !== 'submit') {
            key = encodeURIComponent(element.name);
            value = encodeURIComponent(element.value);
            keysAndValues.push(`${key}=${value}`);
          }
          
          let data = keysAndValues.join('&');
          
          // submit the data
          let request = new XMLHttpRequest();
          request.open('POST', 'https://ls-230-book-catalog.herokuapp.com/books');
          request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
          
          request.addEventListener('load', () => {
            if (request.status === 201) {
              console.log(`This book was added to the catalog: ${request.responseText}`);
            }
          });
        }
      });
      ```

    * ```http
      POST /books HTTP/1.1
      Host: ls-230-book-catalog.herokuapp.com
      Content-Length: 50
      Content-type: application/x-www-form-urlencoded
      Accept: */*
      
      title=Effective%20JavaScript&author=David%20Herman
      ```

  * Submitting a Form with `FormData`

    * Browsers provide the [`FormData` API](https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects#Retrieving_a_FormData_object_from_an_HTML_form) to assist in multi-part serializing a form's data.

    * ```javascript
      let form = document.getElementById('form');
      
      form.addEventListener('submit', event => {
        // prevent the browser from submitting the form and redirecting
        event.preventDefault();
        
        // AS EASY AS DOING THIS LINE HERE
        let data = new FormData(form);
        // AS EASY AS DOING THIS LINE HERE
        
        let request = new XMLHttpRequest();
        request.open('POST', 'https://ls-230-book-catalog.herokuapp.com/books');
        
        request.addEventListener('load', () => {
          if (request.status === 201) {
            console.log(`This book was added to the catalog: ${request.responseText}`);
          }
        });
        
        request.send(data);
      });
      ```

    * ```http
      POST /books HTTP/1.1
      Host: ls-230-book-catalog.herokuapp.com
      Content-Length: 234
      Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryf0PCniJK0bw0lb4e
      Accept: */*
      
      ------WebKitFormBoundaryf0PCniJK0bw0lb4e
      Content-Disposition: form-data; name="title"
      
      Effective JavaScript
      ------WebKitFormBoundaryf0PCniJK0bw0lb4e
      Content-Disposition: form-data; name="author"
      
      David Herman
      ------WebKitFormBoundaryf0PCniJK0bw0lb4e--
      ```

________

* **Example: Loading JSON via XHR**

  * Sometimes it makes more sense to load data in a primitive data structure and render it with the client-side code rather than to retrieve HTML fragments from a server (server-side rendering) and insert them into a page.

  * Modern browsers facilitate this process by providing native support for fetching JSON data using the `responseType` property (valid values: `text`, `json`, `arraybuffer`, `blob`, `document`).

  * ```javascript
    let request = new XMLHttpRequest();
    request.open('GET', 'https://api.github.com/repos/rails/rails');
    request.responseType = 'json'; // specify the desired responseType
    
    request.addEventListener('load', event => {
      // request.response will be the result of parsing the JSON
      // response body or null if the body couldn't be parsed
      // or another error occurred
      
      let data = request.response;
    });
    
    request.send();
    ```

  * ```javascript
    let request = new XMLHttpRequest();
    request.open('GET', 'https://api.github.com/repos/rails/rails');
    request.responseType = 'json';
    
    request.addEventListener('load', event => {
        let data = request.response;
    });
    
    request.addEventListener('error', event => {
        console.log('The request could not be completed!');
    });
    
    request.send();
    
    // after
    console.log(request.status);
    console.log(request.response.open_issues);
    ```

________

* **Example: Sending JSON via XHR**

  * Sending JSON to the server is similar to submitting a form:

    1. Serialize the data into valid JSON
    2. Send response using `XMLHttpRequest`; `Content-Type: application/json; charset=utf-8`
    3. Handle the response

  * Serializing Data to JSON

    * To serialize and send JSON, we update our data to create a valid JSON string:

      * ```javascript
        let request = new XMLHttpRequest();
        request.open('POST', 'https://ls-230-book-catalog.herokuapp.com/books');
        
        let data = { title: 'Eloquent Javascript', author: 'Marijn Haverbeke'};
        let json = JSON.stringify(data);
        
        request.send(json);
        ```

  * Setting the `Content-Type` Header

    * Tell server to expect JSON: `Content-Type` should be `application/json; charset=utf-8`

      * ```javascript
        let request = new XMLHttpRequest();
        request.open('POST', 'https://ls-230-book-catalog.herokuapp.com/books');
        
        request.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
        
        let data = { title: 'Eloquent JavaScript', author: 'Marijn Haverbeke' };
        let json = JSON.stringify(data);
        
        request.send(json);
        ```

  * Exercise

    * ```javascript
      function createProduct(productData) {
        let json = JSON.stringify(productData);
        let request = new XMLHttpRequest();
      
        request.open('POST', 'https://ls-230-web-store-demo.herokuapp.com/v1/products');
        request.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
        request.setRequestHeader('Authorization', 'token AUTH_TOKEN');
      
        request.addEventListener('load', () => {
          console.log(`This product was added: ${request.responseText}`);
        });
      
        request.send(json);
      }
      
      createProduct({
        name: 'HB pencil',
        sku: 'hbp100',
        price: 50,
      });
      ```

________

* **Cross-Domain `XMLHttpRequests` with CORS**

  * Cross-Origin Requests

    * The scheme, hostname, and port of a web page's URL define its origin. A **cross-origin request** occurs when the page tries to access a resource from a different origin.
    * Consider the web page at `http://myside.com/doc1` navigating to each of the following pages:
      * `https://myside.com/doc1`: different scheme/protocol
      * `http://myside.com:4000/doc1`: different port
      * `http://anotherside.com/doc1`: different host

  * Cross-Origin requests with XHR

    * By default, an `XHR` object **cannot send cross-origin requests** because of security vulnerabilities like *XRR* and *CSRF* inherent in cross-domain requests.
    * To circumvent that inability, APIs typically use **Cross-Origin Resource Sharing** (**CORS**)

  * CORS

    * Cross-Origin Resource Sharing is a W3C specification that defines how the browser and server must communicate when accessing resources across origins.

      * CORS lets the two systems know enough about each other to determine whether the response should succeed or fail; applications use custom HTTP request and response headers to implement CORS.

    * Every `XHR` sent by the browser must have an `Origin` header that contains the origin of the requesting page, the server uses this header to determine whether it should send a corresponding header in the response.

      * ```http
        Origin: http://localhost:8080
        ```

    * When a server receives a request with an `Origin` header, it determins whether the request came from an origin that is allowed to see the response. If it is, it sends the response back with an `Access-Control-Allow-Origin` header that contains the same origin.

      * ```http
        Access-Control-Allow-Origin: http://localhost:8080
        ```

    * If the server wants to make a resource available to everyone, it uses the same header w/ `*`:

      * ```http
        Access-Control-Allow-Origin: *
        ```

  * Conclusion

    * The Cross-Origin Resource Sharing specification fulfills the need for legitimate cross-origin requests. It gives us a standard way to access resources from different origins without the security problems associated with cross-origin requests.

### Concepts/Vocab



















